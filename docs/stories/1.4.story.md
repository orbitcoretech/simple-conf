# Story 1.4: Folder & Document CRUD API

## Status

Approved

## Story

**As a** user,
**I want** API endpoints to manage folders and documents,
**so that** I can organize and store knowledge base content.

## Acceptance Criteria

1. `GET /api/folders` returns folder tree structure for authenticated user
2. `POST /api/folders` creates a new folder (name, parent_id optional)
3. `GET /api/folders/:id` returns folder details with child folders and documents list
4. `GET /api/documents/:id` returns full document with content and metadata
5. `POST /api/documents` creates document (title, content, folder_id); sets created_by from JWT
6. `PUT /api/documents/:id` updates document; sets modified_by from JWT, updates timestamp
7. `DELETE /api/documents/:id` soft-deletes or removes document (owner only)
8. All endpoints require valid JWT; return 401 if missing/invalid
9. Document responses include: id, title, content, folder_id, created_by (user object), modified_by, created_at, updated_at

## Tasks / Subtasks

- [x] **Task 1: Create Zod validation schemas for folders and documents** (AC: 2, 5, 6)

  - [x] Create `packages/shared/src/schemas/folder.ts` with `createFolderSchema`
  - [x] Create `packages/shared/src/schemas/document.ts` with `createDocumentSchema`, `updateDocumentSchema`
  - [x] Export schemas from `packages/shared/src/schemas/index.ts`
  - [x] Rebuild shared package

- [ ] **Task 2: Create folder repository** (AC: 1, 2, 3)

  - [ ] Create `apps/api/src/repositories/folder.repository.ts`
  - [ ] Implement `findAll(): Promise<Folder[]>` - get all folders
  - [ ] Implement `findById(id: string): Promise<Folder | null>`
  - [ ] Implement `findChildren(parentId: string | null): Promise<Folder[]>`
  - [ ] Implement `create(data: CreateFolderData): Promise<Folder>`
  - [ ] Implement `getDocumentCount(folderId: string): Promise<number>`

- [ ] **Task 3: Create document repository** (AC: 4, 5, 6, 7, 9)

  - [ ] Create `apps/api/src/repositories/document.repository.ts`
  - [ ] Implement `findById(id: string): Promise<Document | null>`
  - [ ] Implement `findByFolderId(folderId: string): Promise<DocumentSummary[]>`
  - [ ] Implement `create(data: CreateDocumentData): Promise<Document>`
  - [ ] Implement `update(id: string, data: UpdateDocumentData): Promise<Document>`
  - [ ] Implement `delete(id: string): Promise<void>`
  - [ ] Implement `findWithMeta(id: string): Promise<DocumentWithMeta | null>` - includes user info

- [ ] **Task 4: Create folder service** (AC: 1, 2, 3)

  - [ ] Create `apps/api/src/services/folder.service.ts`
  - [ ] Implement `getFolderTree(userId: string): Promise<FolderTreeNode[]>` - build tree with document counts
  - [ ] Implement `getFolderDetails(id: string, userId: string): Promise<FolderDetailResponse>`
  - [ ] Implement `createFolder(data, userId): Promise<Folder>`
  - [ ] Handle folder visibility/access based on user department

- [ ] **Task 5: Create document service** (AC: 4, 5, 6, 7, 9)

  - [ ] Create `apps/api/src/services/document.service.ts`
  - [ ] Implement `getDocument(id: string, userId: string): Promise<DocumentWithMeta>`
  - [ ] Implement `createDocument(data, userId): Promise<Document>`
  - [ ] Implement `updateDocument(id, data, userId): Promise<Document>` - verify ownership
  - [ ] Implement `deleteDocument(id, userId): Promise<void>` - verify ownership

- [ ] **Task 6: Create folder routes module** (AC: 1, 2, 3, 8)

  - [ ] Create `apps/api/src/modules/folders/folders.routes.ts`
  - [ ] `GET /folders` - require auth, return folder tree
  - [ ] `POST /folders` - require auth, validate input, create folder
  - [ ] `GET /folders/:id` - require auth, return folder with contents
  - [ ] Create `apps/api/src/modules/folders/index.ts`
  - [ ] Register folder routes in `apps/api/src/app.ts`

- [ ] **Task 7: Create document routes module** (AC: 4, 5, 6, 7, 8, 9)

  - [ ] Create `apps/api/src/modules/documents/documents.routes.ts`
  - [ ] `GET /documents/:id` - require auth, return full document with meta
  - [ ] `POST /documents` - require auth, validate input, create document
  - [ ] `PUT /documents/:id` - require auth, validate input, verify owner, update
  - [ ] `DELETE /documents/:id` - require auth, verify owner, delete
  - [ ] Create `apps/api/src/modules/documents/index.ts`
  - [ ] Register document routes in `apps/api/src/app.ts`

- [ ] **Task 8: Add API response types** (AC: 9)

  - [ ] Update `packages/shared/src/types/api.ts` with folder/document response types
  - [ ] Add `FolderTreeResponse`, `FolderDetailResponse`
  - [ ] Add `DocumentResponse`, `CreateDocumentResponse`
  - [ ] Export from shared package

- [ ] **Task 9: Write unit tests** (AC: 1-9)

  - [ ] Create `apps/api/tests/unit/services/folder.service.test.ts`
  - [ ] Create `apps/api/tests/unit/services/document.service.test.ts`
  - [ ] Test folder tree building logic
  - [ ] Test ownership verification for document updates/deletes

- [ ] **Task 10: Write integration tests** (AC: 1-9)
  - [ ] Create `apps/api/tests/integration/folders.test.ts`
  - [ ] Create `apps/api/tests/integration/documents.test.ts`
  - [ ] Test all folder endpoints with auth
  - [ ] Test all document endpoints with auth
  - [ ] Test 401 for missing/invalid tokens
  - [ ] Test 403 for non-owner document modifications

## Dev Notes

### Previous Story Insights

[Source: docs/stories/1.2.story.md, docs/stories/1.3.story.md]

**From Story 1.2:**

- Database schema established with `users`, `folders`, `documents` tables
- Drizzle ORM configured with schemas in `apps/api/src/db/schema/`
- Foreign key relationships: documents → folders, folders → folders (parent)
- Types defined in `packages/shared/src/types/`

**From Story 1.3:**

- Authentication middleware at `apps/api/src/middleware/authenticate.ts`
- JWT plugin configured, extracts user from token
- User repository pattern established
- Zod validation pattern for request schemas
- Error response format with codes: `UNAUTHORIZED`, `FORBIDDEN`, `NOT_FOUND`

### API Specification

[Source: architecture/api-specification.md#Folder Endpoints, #Document Endpoints]

**Folder Endpoints:**

| Method | Endpoint       | Purpose                          | Auth Required |
| ------ | -------------- | -------------------------------- | ------------- |
| GET    | `/folders`     | Get folder tree for current user | Yes           |
| GET    | `/folders/:id` | Get folder details with contents | Yes           |
| POST   | `/folders`     | Create new folder                | Yes           |

```typescript
// GET /folders
interface FoldersResponse {
  folders: FolderTreeNode[];
}

// GET /folders/:id
interface FolderDetailResponse {
  folder: Folder;
  breadcrumbs: { id: string; name: string }[];
  subfolders: FolderWithMeta[];
  documents: DocumentSummary[];
}

// POST /folders
interface CreateFolderRequest {
  name: string;
  parentId: string | null;
}
```

**Document Endpoints:**

| Method | Endpoint         | Purpose                             | Auth Required |
| ------ | ---------------- | ----------------------------------- | ------------- |
| GET    | `/documents/:id` | Get full document (increments view) | Yes           |
| POST   | `/documents`     | Create new document                 | Yes           |
| PUT    | `/documents/:id` | Update document                     | Yes (owner)   |
| DELETE | `/documents/:id` | Delete document                     | Yes (owner)   |

```typescript
// GET /documents/:id
interface DocumentResponse {
  document: DocumentWithMeta;
}

// POST /documents
interface CreateDocumentRequest {
  title: string;
  content: string;
  folderId: string;
}

// PUT /documents/:id
interface UpdateDocumentRequest {
  title?: string;
  content?: string;
}
```

### Data Models

[Source: architecture/data-models.md]

**FolderTreeNode:**

```typescript
interface FolderTreeNode {
  id: string;
  name: string;
  parentId: string | null;
  visibility: FolderVisibility;
  department: Department | null;
  documentCount: number;
  isAccessible: boolean;
  children: FolderTreeNode[];
}
```

**FolderWithMeta:**

```typescript
interface FolderWithMeta extends Folder {
  documentCount: number;
  isAccessible: boolean;
  children?: FolderWithMeta[];
}
```

**DocumentWithMeta:**

```typescript
interface DocumentWithMeta extends Document {
  commentCount: number;
  createdByUser: PublicUser;
  modifiedByUser: PublicUser | null;
  folderPath: string;
}
```

**DocumentSummary:**

```typescript
interface DocumentSummary {
  id: string;
  title: string;
  folderId: string;
  folderPath: string;
  createdBy: PublicUser;
  updatedAt: Date;
  viewCount: number;
  commentCount: number;
}
```

### Folder Visibility Logic

[Source: architecture/data-models.md#Folder]

- `visibility: 'public'` - accessible to all authenticated users
- `visibility: 'department'` - accessible only to users in matching department
- `isAccessible` flag computed based on user's department vs folder's department

```typescript
function isAccessible(folder: Folder, userDepartment: Department): boolean {
  if (folder.visibility === "public") return true;
  return folder.department === userDepartment;
}
```

### Error Handling

[Source: architecture/error-handling.md]

| Code             | HTTP Status | Usage                         |
| ---------------- | ----------- | ----------------------------- |
| UNAUTHORIZED     | 401         | Missing/invalid token         |
| FORBIDDEN        | 403         | Not owner of document         |
| NOT_FOUND        | 404         | Folder/document doesn't exist |
| VALIDATION_ERROR | 400         | Invalid request body          |

### File Locations

[Source: architecture/project-structure.md]

```
apps/api/src/
├── repositories/
│   ├── user.repository.ts        # EXISTS from Story 1.3
│   ├── folder.repository.ts      # NEW
│   └── document.repository.ts    # NEW
├── services/
│   ├── auth.service.ts           # EXISTS from Story 1.3
│   ├── folder.service.ts         # NEW
│   └── document.service.ts       # NEW
├── modules/
│   ├── auth/                     # EXISTS from Story 1.3
│   ├── folders/
│   │   ├── index.ts              # NEW
│   │   └── folders.routes.ts     # NEW
│   └── documents/
│       ├── index.ts              # NEW
│       └── documents.routes.ts   # NEW
└── app.ts                        # UPDATE: Register new routes

apps/api/tests/
├── unit/
│   └── services/
│       ├── auth.service.test.ts  # EXISTS from Story 1.3
│       ├── folder.service.test.ts  # NEW
│       └── document.service.test.ts # NEW
└── integration/
    ├── auth.test.ts              # EXISTS from Story 1.3
    ├── folders.test.ts           # NEW
    └── documents.test.ts         # NEW

packages/shared/src/
├── types/
│   ├── folder.ts                 # EXISTS - may need FolderTreeNode additions
│   ├── document.ts               # EXISTS - may need DocumentSummary additions
│   └── api.ts                    # UPDATE: Add response types
└── schemas/
    ├── auth.ts                   # EXISTS from Story 1.3
    ├── folder.ts                 # NEW
    └── document.ts               # NEW
```

### Validation Schemas

```typescript
// packages/shared/src/schemas/folder.ts
import { z } from "zod";

export const createFolderSchema = z.object({
  name: z.string().min(1, "Folder name is required").max(255),
  parentId: z.string().uuid().nullable(),
});

export type CreateFolderInput = z.infer<typeof createFolderSchema>;
```

```typescript
// packages/shared/src/schemas/document.ts
import { z } from "zod";

export const createDocumentSchema = z.object({
  title: z.string().min(1, "Title is required").max(500),
  content: z.string(),
  folderId: z.string().uuid("Invalid folder ID"),
});

export const updateDocumentSchema = z.object({
  title: z.string().min(1).max(500).optional(),
  content: z.string().optional(),
});

export type CreateDocumentInput = z.infer<typeof createDocumentSchema>;
export type UpdateDocumentInput = z.infer<typeof updateDocumentSchema>;
```

### Coding Standards

[Source: architecture/coding-standards.md]

| Rule           | Application                                 |
| -------------- | ------------------------------------------- |
| API Routes     | kebab-case (`/folders/:id`)                 |
| Database       | Repository pattern                          |
| Authentication | Use `authenticate` middleware on all routes |
| Type Sharing   | All types in `@simpleconf/shared`           |

### Testing

[Source: architecture/testing-strategy.md]

**Test Locations:**

- Unit: `apps/api/tests/unit/services/`
- Integration: `apps/api/tests/integration/`

**Testing Framework:** Vitest

**Key Test Scenarios:**

- Folder tree returns correct structure with document counts
- Folder visibility filters based on user department
- Document CRUD operations with owner verification
- 401 for unauthenticated requests
- 403 for non-owner document modifications
- 404 for non-existent resources

## Change Log

| Date       | Version | Description           | Author         |
| ---------- | ------- | --------------------- | -------------- |
| 2025-12-19 | 0.1     | Initial draft created | Bob (SM Agent) |

---

## Dev Agent Record

### Agent Model Used

<!-- To be filled by dev agent -->

### Debug Log References

<!-- To be filled by dev agent -->

### Completion Notes List

<!-- To be filled by dev agent -->

### File List

<!-- To be filled by dev agent -->

---

## QA Results

<!-- To be filled by QA agent -->
